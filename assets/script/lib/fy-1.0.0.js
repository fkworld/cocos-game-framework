!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t=t||self).fy={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])})(t,e)};var e=function(){return(e=Object.assign||function(t){for(var n,e=1,o=arguments.length;e<o;e++)for(var i in n=arguments[e])Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i]);return t}).apply(this,arguments)};function o(t,n,e,o){return new(e||(e=Promise))((function(i,r){function c(t){try{u(o.next(t))}catch(t){r(t)}}function a(t){try{u(o.throw(t))}catch(t){r(t)}}function u(t){var n;t.done?i(t.value):(n=t.value,n instanceof e?n:new e((function(t){t(n)}))).then(c,a)}u((o=o.apply(t,n||[])).next())}))}function i(t,n){var e,o,i,r,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(e)throw new TypeError("Generator is already executing.");for(;c;)try{if(e=1,o&&(i=2&r[0]?o.return:r[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,o=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(!(i=c.trys,(i=i.length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){c=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){c.label=r[1];break}if(6===r[0]&&c.label<i[1]){c.label=i[1],i=r;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(r);break}i[2]&&c.ops.pop(),c.trys.pop();continue}r=n.call(t,c)}catch(t){r=[6,t],o=0}finally{e=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}function r(t,n){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var o,i,r=e.call(t),c=[];try{for(;(void 0===n||n-- >0)&&!(o=r.next()).done;)c.push(o.value)}catch(t){i={error:t}}finally{try{o&&!o.done&&(e=r.return)&&e.call(r)}finally{if(i)throw i.error}}return c}function c(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(r(arguments[n]));return t}var a,u,s,l,f,d,_,p=new cc.EventTarget,v=function(t,n,e){var o={};p.on(t,(function(){n()&&(p.targetOff(o),e())}),o)},h="@fy:",g=function(t){return o(void 0,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(n){return setTimeout(n,1e3*t)}))];case 1:return n.sent(),[2]}}))}))},y=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return t.replace(/\{([0-9]+?)\}/g,(function(t,e){var o;return null!==(o=n[e])&&void 0!==o?o:"{"+e+"}"}))},m=function(){function t(t){this.source=new Map,this.source=new Map(Object.entries(t))}return t.prototype.has=function(t){return this.source.has(t)},t.prototype.get=function(t){return this.source.get(t)},t.prototype.get_all=function(){return this.source},t.prototype.add=function(t,n){void 0===n&&(n=null),this.source.set(t,n)},t.prototype.del=function(t,n){this.source.delete(t)},t.prototype.log_keys=function(){return JSON.stringify(c(this.source.keys()))},t}(),w=function(n){t.version_center=new m(n),t.version_center.get_all().forEach((function(n,e){!n&&t.version_center.del(e)}))},b=function(t){CC_EDITOR&&w(t)},x=function(n,e){w(n),cc.log(h,"初始化version模块成功",t.version_center.log_keys(),JSON.stringify(e))},S=function(n){a=new Map,u=n,t.version_center.has("resetLocal")&&cc.sys.localStorage.clear(),cc.log(h,"初始化local模块成功，local_config=",n)},C=function(t){var n,e,o=null!==(e=null!==(n=a.get(t))&&void 0!==n?n:cc.sys.localStorage.getItem(t))&&void 0!==e?e:""+u[t];return a.set(t,o),o},E=function(t,n){a.set(t,n),Promise.resolve().then((function(){cc.sys.localStorage.setItem(t,n)}))},O=function(){function t(t,n){this.state=n,this.states=t,this.is_lock=!1}return t.prototype.lock=function(){this.is_lock=!0},t.prototype.unlock=function(){this.is_lock=!1},t.prototype.is_state=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return t.includes(this.state)},t.prototype.is_state_with_lock=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this.is_state.apply(this,c(t))&&!this.is_lock},t.prototype.can_go_state=function(t){return this.states[this.state].includes(t)},t.prototype.can_go_state_with_lock=function(t){return this.can_go_state(t)&&!this.is_lock},t.prototype.try_go_state=function(t){return!!this.can_go_state(t)&&(this.state=t,!0)},t.prototype.try_go_state_with_lock=function(t){return!!this.can_go_state_with_lock(t)&&(this.state=t,!0)},t}(),I=function(t){var n=t.getComponent(cc.Widget);n&&n.enabled&&(n.updateAlignment(),n.alignMode!==cc.Widget.AlignMode.ONCE&&n.alignMode!==cc.Widget.AlignMode.ON_WINDOW_RESIZE||(n.enabled=!1))},k=function(t,n){return o(void 0,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,new Promise((function(e){if(CC_EDITOR){var o="db://assets/resources/"+t;new cc.SpriteFrame instanceof n&&(o=cc.path.join(o,V(o)));var i=Editor.assetdb.remote.urlToUuid(o);cc.loader.load({type:"uuid",uuid:i},(function(n,o){n&&cc.warn(h,"载入资源失败, path="+t+", err="+n),e(n?null:o)}))}else t=cc.path.mainFileName(t),cc.loader.loadRes(t,n,(function(n,o){n&&cc.warn(h,"载入资源失败, path="+t+", err="+n),e(n?null:o)}))}))];case 1:return[2,e.sent()]}}))}))},M=cc.Intersection.lineLine,P=cc.Intersection.lineRect,N=cc.Intersection.linePolygon,j=cc.Intersection.rectRect,R=cc.Intersection.rectPolygon,D=cc.Intersection.polygonPolygon,T=cc.Intersection.polygonCircle,A=cc.Intersection.circleCircle,W=cc.Intersection.pointInPolygon,L=cc.Intersection.pointLineDistance,V=function(t){return cc.path.basename(t,cc.path.extname(t))},z=function(t){s=new Map(Object.entries(t).map((function(t){var n=r(t,2),e=n[0],o=n[1],i={fsm:new O({prepare:["ok","error"],ok:[],error:[]},"prepare"),type:e.includes("###")?"music":"sound",url:o};return cc.audioEngine.setMaxAudioInstance(1),[e,i]}))),l="true"===C("music"),f="true"===C("sound"),cc.log(h,"初始化audio模块成功，audio_config=",t)},J=function(t){return o(void 0,void 0,void 0,(function(){var n,e;return i(this,(function(o){switch(o.label){case 0:return(n=s.get(t)).clip?[3,2]:(e=n,[4,k(n.url,cc.AudioClip)]);case 1:e.clip=o.sent(),n.fsm.try_go_state(n.clip?"ok":"error"),o.label=2;case 2:return s.set(t,n),[2]}}))}))},F=function(t){return o(void 0,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,J(t)];case 1:return n.sent(),[2,s.get(t)]}}))}))},G=function(t){CC_EDITOR&&(d=t)},H=function(t){d=t,cc.log(h,"初始化color模块成功，color_config=",t)},B=function(t){return o(void 0,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return CC_EDITOR?[4,k(t,cc.JsonAsset)]:[3,2];case 1:_=n.sent().json,n.label=2;case 2:return[2]}}))}))},U=function(t){return o(void 0,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,k(t,cc.JsonAsset)];case 1:return _=n.sent().json,cc.log(h,"初始化meta模块成功，metas=",_),[2]}}))}))},Z=function(){function t(){}return Object.defineProperty(t,"meta_merge",{get:function(){return this.meta_merge||(this._meta_merge=this.meta_names.reduce((function(t,n){return e({},_[n])}),{})),this.meta_merge},enumerable:!0,configurable:!0}),t.prototype.use_special=function(t){},t.prototype.use_default=function(t){},t._meta_merge=null,t}(),X=function(t,n){var e=new t,o=t.meta_merge[n];return o?e.use_special(o):e.use_default(n),e},q="org/cocos2dx/javascript/",K="(Ljava/lang/String;)Ljava/lang/String;",Q=new Map,Y=function(){return cc.sys.isNative&&cc.sys.os==cc.sys.OS_ANDROID},$=function(){return cc.sys.isNative&&cc.sys.os==cc.sys.OS_IOS},tt=function(t,n){return $()?(cc.log(h,t,n),jsb.reflection.callStaticMethod("JSBinding",t+":",n)):Y()?(cc.log(h,t,n),jsb.reflection.callStaticMethod(q+"JSBinding",t,K,n)):null};window.NativeCallback=function(t,n){console.log(h,"NativeCallback",t,n),Q.set(t,n),p.emit("@event:native/native-callback")};var nt=null,et=0,ot=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return function(t,e){function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}(e,t),e.context=null,e}(cc.Component),it=function(t){nt=t,cc.log(h,"初始化panel模块成功，panel_parent=",t)},rt=function(t){return o(void 0,void 0,void 0,(function(){var n;return i(this,(function(e){switch(e.label){case 0:return t.context.prefab?[3,2]:(n=t.context,[4,k(t.context.path,cc.Prefab)]);case 1:n.prefab=e.sent(),e.label=2;case 2:return[2]}}))}))},ct=function(t){return o(void 0,void 0,void 0,(function(){var n;return i(this,(function(e){switch(e.label){case 0:return[4,rt(t)];case 1:return e.sent(),t.context.ins?[3,3]:((n=cc.instantiate(t.context.prefab)).parent=nt,n.position=cc.Vec3.ZERO,n.width=cc.winSize.width,n.height=cc.winSize.height,t.context.ins=n.getComponent(t),[4,t.context.ins.on_create()]);case 2:e.sent(),e.label=3;case 3:return[2,t.context.ins]}}))}))};!function(t){var n=this,e=Symbol();t.set_all=function(n,o,i){n[e]=i,o&&t.no_anima(n,o)},t.no_anima=function(t,n){cc.tween(t).set(t[e][n]).start()},t.anima=function(t,r,c){return o(n,void 0,void 0,(function(){var n,o,a;return i(this,(function(i){switch(i.label){case 0:return c.time=null!==(n=c.time)&&void 0!==n?n:.3,c.delay=null!==(o=c.delay)&&void 0!==o?o:0,c.ease=null!==(a=c.ease)&&void 0!==a?a:"linear",[4,new Promise((function(n){cc.tween(t).delay(c.delay).to(c.time,t[e][r],{easing:c.ease}).call(n).start()}))];case 1:return i.sent(),[2]}}))}))}}(t.SimpleNodeAnima||(t.SimpleNodeAnima={}));var at,ut,st=function(t,n){CC_EDITOR&&!(at=t)[ut=n]&&cc.log(h,"无法载入编辑器text语言")},lt=function(t){at=t,cc.log(h,"初始化text模块成功，text_config=",t)},ft=function(){return C("language")},dt=function(t,n,e){return void 0===e&&(e=!1),e?Math.random()*(n-t)+t:(t=Math.ceil(t),n=Math.ceil(n),Math.floor(Math.random()*(n-t)+t))};t.DeDevConsole=function(t){CC_DEV&&(window[t.name]=t)},t.DeDevConsoleNamespace=function(t,n){CC_DEV&&(window[t]=n)},t.DeSetMetaContext=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return function(n){n.meta_names=t}},t.DeSetPanelContext=function(t,n,e){return void 0===n&&(n="old"),void 0===e&&(e=0),function(o){o.context={path:t,z_index_base:e,type:n,prefab:null,ins:null,state:new O({open:["close"],close:["open"]},"close")}}},t.EVENT_LANGUAGE_CHANGE="@event:text/language-change",t.EVENT_MUSIC_SWITCH_OPEN="@event:audio/music-switch-open",t.MetaBase=Z,t.PanelBase=ot,t.SimpleFSM=O,t.StateTable=m,t.TAG=h,t.VERSION="1.0.0",t.VERSION_TIME="2020.5.11",t._init_audio_runtime=z,t._init_color_editor=G,t._init_color_runtime=H,t._init_local_runtime=S,t._init_meta_editor_async=B,t._init_meta_runtime_async=U,t._init_panel_runtime=it,t._init_text_editor=st,t._init_text_runtime=lt,t._init_version_editor=b,t._init_version_runtime=x,t.adjust_canvas=function(t){var n=cc.view.getFrameSize().width/cc.view.getFrameSize().height>=t.designResolution.width/t.designResolution.height;t.fitHeight=n,t.fitWidth=!n},t.call=tt,t.call_async=function(t,n,e){return o(void 0,void 0,void 0,(function(){var e,o;return i(this,(function(i){return e=t+"/"+Date.now().toString(36)+"/"+Math.random().toFixed(5),o=Object.assign(n,{call_id:e}),tt(t,JSON.stringify(o)),[2,new Promise((function(t){v("@event:native/native-callback",(function(){return Q.has(e)}),(function(){var n=Q.get(e);Q.delete(e),t(n)}))}))]}))}))},t.change_language=function(t){E("language",t),p.emit("@event:text/language-change")},t.circleCircle=A,t.close_panel=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return o(void 0,void 0,void 0,(function(){var e;return i(this,(function(o){switch(o.label){case 0:return t.context.state.try_go_state("close")?[4,(e=t.context.ins).on_close.apply(e,c(n))]:[2];case 1:return o.sent(),"new"===t.context.type?(t.context.ins.node.destroy(),t.context.ins=null):"old"===t.context.type&&(t.context.ins.node.active=!1),[2]}}))}))},t.do_delay=g,t.do_widget=I,t.do_widget_all=function(t){t.getComponentsInChildren(cc.Widget).forEach((function(t){return I(t.node)}))},t.do_with_frame=function(t,n,e,r){return o(void 0,void 0,void 0,(function(){return i(this,(function(o){switch(o.label){case 0:return[4,new Promise((function(o){var i=(n-1)*e,c=0,a=0;r.schedule((function(){c%e==0&&(t(a),a+=1),(c+=1)>i&&o()}),0,i)}))];case 1:return o.sent(),[2]}}))}))},t.event_center=p,t.get_color=function(t){return d[t]?cc.color().fromHEX(d[t]):(cc.warn(h,"获取color失败，key="+t),cc.Color.WHITE)},t.get_filename=V,t.get_language=ft,t.get_local=C,t.get_meta=X,t.get_metas=function(t){return Object.keys(t.meta_merge).map((function(n){return X(t,n)}))},t.get_metas_ids=function(t){return Object.keys(t.meta_merge)},t.get_music_switch=function(){return l},t.get_node_wp=function(t){return t.convertToWorldSpaceAR(cc.Vec3.ZERO)},t.get_positive_mode=function(t,n){return(t%n+n)%n},t.get_sound_switch=function(){return f},t.get_template_string=y,t.get_text=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var o=CC_EDITOR?at[ut][t]:at[ft()][t];return o?y.apply(void 0,c([o],n)):(cc.warn(h,"key不存在, key="+t),t)},t.init_editor=function(t){return o(void 0,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return b(t.version),st(t.text,t.editor_language),G(t.color),[4,B(t.meta_json_file)];case 1:return n.sent(),[2]}}))}))},t.init_runtime=function(t){return o(void 0,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return x(t.version,t.version_info),S(t.local),lt(t.text),H(t.color),z(t.audio),it(t.panel_parent),[4,U(t.meta_json_file)];case 1:return n.sent(),cc.log(h,"初始化框架成功","1.0.0","2020.5.11"),[2]}}))}))},t.is_android=Y,t.is_ios=$,t.is_native=function(){return cc.sys.isNative},t.is_prob=function(t){return Math.random()<=t},t.lineLine=M,t.linePolygon=N,t.lineRect=P,t.load_res=k,t.load_res_dir=function(t,n){return o(void 0,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,new Promise((function(e){cc.loader.loadResDir(t,n,(function(n,o){n&&cc.warn(h,"载入资源组失败, path="+t+", err="+n),e(n?null:o)}))}))];case 1:return[2,e.sent()]}}))}))},t.on_success_once_event=v,t.open_panel=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return o(void 0,void 0,void 0,(function(){var e,o,r;return i(this,(function(i){switch(i.label){case 0:return t.context.state.try_go_state("open")?(e=et+=1,[4,ct(t)]):[2];case 1:return(o=i.sent()).node.zIndex=e+t.context.z_index_base,o.node.active=!0,[4,(r=t.context.ins).on_open.apply(r,c(n))];case 2:return i.sent(),[2]}}))}))},t.play_audio=function(t){return o(void 0,void 0,void 0,(function(){var n;return i(this,(function(e){switch(e.label){case 0:return[4,F(t)];case 1:return(n=e.sent()).fsm.is_state("error")||"music"===n.type&&!l||"sound"===n.type&&!f||(n.id="music"===n.type?cc.audioEngine.playMusic(n.clip,!0):cc.audioEngine.playEffect(n.clip,!1)),[2]}}))}))},t.pointInCircle=function(t,n){return t.sub(n.position).len()<=n.radius},t.pointInPolygon=W,t.pointLineDistance=L,t.polygonCircle=T,t.polygonPolygon=D,t.pre_audio=J,t.pre_panel=rt,t.random=dt,t.random_array_item=function(t){return t[Math.trunc(Math.random()*t.length)]},t.random_position=function(t){return cc.v3(dt(-t,t,!0),dt(-t,t,!0))},t.random_prob=function(t){var n=Math.random(),e=t.map((function(t,n){return{index:n,prob:t}})).sort((function(t,n){return t.prob-n.prob})),o=e.find((function(t){return(n-=t.prob)<=0}));return o?o.index:e.length-1},t.rectPolygon=R,t.rectRect=j,t.reverse_music_switch=function(){(l=!l)?p.emit("@event:audio/music-switch-open"):cc.audioEngine.stopAll(),E("music",""+l)},t.reverse_sound_switch=function(){E("sound",""+(f=!f))},t.set_local=E,t.set_node_by_wp=function(t,n,e){void 0===e&&(e=!1);var o=t.parent.convertToNodeSpaceAR(n);return e&&(t.position=o),o},t.stop_audio=function(t){return o(void 0,void 0,void 0,(function(){var n;return i(this,(function(e){switch(e.label){case 0:return[4,F(t)];case 1:return(n=e.sent()).fsm.is_state("error")||n.id&&cc.audioEngine.stop(n.id),[2]}}))}))},t.wait_for_do=function(t,n,e,r){return void 0===e&&(e=5),void 0===r&&(r=.5),o(void 0,void 0,void 0,(function(){var o,c;return i(this,(function(i){switch(i.label){case 0:o=0,c=0,i.label=1;case 1:return c<100?n()?(t(),[3,5]):[3,2]:[3,5];case 2:return(o+=r)>=e?[3,5]:[4,g(r)];case 3:i.sent(),i.label=4;case 4:return c+=1,[3,1];case 5:return[2]}}))}))},Object.defineProperty(t,"__esModule",{value:!0})}));
